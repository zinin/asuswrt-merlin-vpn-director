#!/bin/sh
# Auto-generated by telegram-bot /update command
# Do not edit manually

set -e

CHAT_ID={{.ChatID}}
OLD_VERSION="{{.OldVersion}}"
NEW_VERSION="{{.NewVersion}}"
UPDATE_DIR="{{.UpdateDir}}"
FILES_DIR="{{.FilesDir}}"
NOTIFY_FILE="{{.NotifyFile}}"
LOCK_FILE="{{.LockFile}}"
LOG_FILE="$UPDATE_DIR/update.log"
BOT_PATH="/opt/vpn-director/telegram-bot"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOG_FILE"
}

log "Starting update from $OLD_VERSION to $NEW_VERSION"

# 1. Unmonitor in monit (if available) - optional, continue on failure
if command -v monit >/dev/null 2>&1; then
    log "Unmonitoring telegram-bot in monit"
    monit unmonitor telegram-bot 2>/dev/null || true
fi

# 2. Stop bot
log "Stopping telegram-bot"
/opt/etc/init.d/S98telegram-bot stop
sleep 1

# 3. Wait for process to exit (max 30 seconds)
# Using full path to avoid matching unrelated processes
count=0
while pgrep -f "$BOT_PATH" >/dev/null 2>&1 && [ $count -lt 30 ]; do
    sleep 1
    count=$((count + 1))
done

if pgrep -f "$BOT_PATH" >/dev/null 2>&1; then
    log "WARNING: telegram-bot still running after 30s, killing"
    # Use || true to handle race: process may exit between pgrep and pkill
    pkill -9 -f "$BOT_PATH" || true
    sleep 1
fi

# 4. Copy files - NO || true, fail on error
log "Copying files"
cp -f "$FILES_DIR/opt/vpn-director/"*.sh /opt/vpn-director/
cp -f "$FILES_DIR/opt/vpn-director/lib/"*.sh /opt/vpn-director/lib/
cp -f "$FILES_DIR/opt/vpn-director/"*.template /opt/vpn-director/
cp -f "$FILES_DIR/opt/etc/xray/"*.template /opt/etc/xray/
cp -f "$FILES_DIR/opt/etc/init.d/"* /opt/etc/init.d/
cp -f "$FILES_DIR/jffs/scripts/"* /jffs/scripts/
cp -f "$FILES_DIR/telegram-bot" /opt/vpn-director/telegram-bot

# 5. Set permissions
chmod +x /opt/vpn-director/*.sh
chmod +x /opt/vpn-director/lib/*.sh
chmod +x /opt/etc/init.d/S98telegram-bot
chmod +x /opt/etc/init.d/S99vpn-director
chmod +x /jffs/scripts/firewall-start
chmod +x /jffs/scripts/wan-event
chmod +x /opt/vpn-director/telegram-bot

# 6. Create notify file
log "Creating notify file"
cat > "$NOTIFY_FILE" << EOF
{"chat_id":$CHAT_ID,"old_version":"$OLD_VERSION","new_version":"$NEW_VERSION"}
EOF

# 7. Remove lock
rm -f "$LOCK_FILE"

# 8. Re-monitor in monit (if available) - optional, continue on failure
if command -v monit >/dev/null 2>&1; then
    log "Re-monitoring telegram-bot in monit"
    monit monitor telegram-bot 2>/dev/null || true
fi

# 9. Start bot
log "Starting telegram-bot"
/opt/etc/init.d/S98telegram-bot start

# 10. Cleanup deferred to bot after successful startup notification
# (leave $UPDATE_DIR for notify.json and update.log)
log "Update script completed"
