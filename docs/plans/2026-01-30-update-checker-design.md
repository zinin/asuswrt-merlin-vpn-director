# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

–î–∏–∑–∞–π–Ω —Ñ–æ–Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## –û–±–∑–æ—Ä

–ë–æ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç GitHub –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö —Ä–µ–ª–∏–∑–æ–≤. –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å changelog –∏ –∫–Ω–æ–ø–∫–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–∞—é—Ç –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ `allowed_users`, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ–≥–¥–∞-–ª–∏–±–æ –ø–∏—Å–∞–ª–∏ –±–æ—Ç—É
- Chat ID —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ `chats.json` (–Ω–µ –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
- Per-user tracking —É–≤–µ–¥–æ–º–ª—ë–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (opt-in —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥)
- –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è, –Ω–æ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è

## –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### chats.json

–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: `/opt/vpn-director/data/chats.json`

```json
{
  "john_doe": {
    "chat_id": 123456789,
    "first_seen": "2024-01-15T10:30:00Z",
    "last_seen": "2024-01-20T14:22:00Z",
    "active": true,
    "notified_versions": ["v1.2.0", "v1.2.1"]
  },
  "jane_smith": {
    "chat_id": 987654321,
    "first_seen": "2024-01-18T09:00:00Z",
    "last_seen": "2024-01-18T09:00:00Z",
    "active": false,
    "notified_versions": []
  }
}
```

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ telegram-bot.json

```json
{
  "bot_token": "...",
  "allowed_users": ["john_doe", "jane_smith"],
  "log_level": "info",
  "update_check_interval": "1h"
}
```

- `update_check_interval` ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ñ–æ—Ä–º–∞—Ç Go duration (`1m`, `1h`, `24h`)
- –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ `"0"` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç–∫–ª—é—á–µ–Ω–∞

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `internal/chatstore/store.go` | –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ chat_id —Å thread-safe –¥–æ—Å—Ç—É–ø–æ–º |
| `internal/updatechecker/checker.go` | –§–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π |

### ChatStore –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

```go
type ChatStore interface {
    // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥—è—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    RecordInteraction(username string, chatID int64) error

    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    GetActiveUsers() ([]UserChat, error)

    // –ü–æ–º–µ—Ç–∏—Ç—å –≤–µ—Ä—Å–∏—é –∫–∞–∫ notified –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    MarkNotified(username string, version string) error

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —É–≤–µ–¥–æ–º–ª—ë–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ –≤–µ—Ä—Å–∏–∏
    IsNotified(username string, version string) bool

    // –ü–æ–º–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º (–æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏)
    SetInactive(username string) error
}

type UserChat struct {
    Username string
    ChatID   int64
}
```

### UpdateChecker

–ì–æ—Ä—É—Ç–∏–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º–∞—è –≤ `main.go`:
- –¢–∏–∫–µ—Ä —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `updater.Service` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è latest release
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ChatStore` –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∏ tracking notified versions
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `telegram.Sender` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## –õ–æ–≥–∏–∫–∞ UpdateChecker

### –¶–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∫–∞–∂–¥—ã–π tick)

```
1. –ü–æ–ª—É—á–∏—Ç—å latest release —Å GitHub (updater.GetLatestRelease())
2. –°—Ä–∞–≤–Ω–∏—Ç—å —Å —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π (updater.CompareVersions())
3. –ï—Å–ª–∏ latest <= current ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å
4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ ChatStore:
   a. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å IsNotified(username, latestVersion)
   b. –ï—Å–ª–∏ —É–∂–µ —É–≤–µ–¥–æ–º–ª—ë–Ω ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
   c. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å changelog + –∫–Ω–æ–ø–∫–æ–π
   d. –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Üí MarkNotified(username, latestVersion)
   e. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "blocked/not found" ‚Üí SetInactive(username)
   f. –ï—Å–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –Ω–µ –ø–æ–º–µ—á–∞—Ç—å notified
```

### –§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```
üÜï –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è v1.2.1

–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: v1.2.0

üìã –ß—Ç–æ –Ω–æ–≤–æ–≥–æ:
- Added /update command for self-updating
- Refactored to modular architecture
- Fixed memory leak in wizard

[üîÑ –û–±–Ω–æ–≤–∏—Ç—å]
```

- Changelog –±–µ—Ä—ë—Ç—Å—è –∏–∑ `release.Body` (GitHub release notes)
- –û–±—Ä–µ–∑–∞–µ—Ç—Å—è –¥–æ ~500 —Å–∏–º–≤–æ–ª–æ–≤ –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
- –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å" –≤—ã–∑—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π callback –æ–±—Ä–∞–±–æ—Ç–∫–∏ `/update`

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

### –ó–∞–ø–∏—Å—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π

–í `bot.Run()` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (`internal/bot/bot.go`):

```go
// –¢–µ–∫—É—â–∏–π –∫–æ–¥:
if !b.auth.IsAuthorized(username) {
    continue
}

// –î–æ–±–∞–≤–∏—Ç—å:
if b.chatStore != nil {
    _ = b.chatStore.RecordInteraction(username, msg.Chat.ID)
}
```

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è callback queries. –û–±–Ω–æ–≤–ª—è–µ—Ç `last_seen` –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `active: true`.

### –ò–Ω—ä–µ–∫—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–í `main.go`:

```go
chatStore := chatstore.New(paths.DataDir + "/chats.json")

bot := bot.New(cfg,
    bot.WithChatStore(chatStore),
    // ... existing options
)

// –ó–∞–ø—É—Å–∫ checker –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª > 0
if cfg.UpdateCheckInterval > 0 {
    checker := updatechecker.New(updater, chatStore, sender, currentVersion)
    go checker.Run(ctx, cfg.UpdateCheckInterval)
}
```

### Graceful shutdown

UpdateChecker —Å–ª—É—à–∞–µ—Ç `ctx.Done()` –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è.

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### GitHub API
- Rate limit / timeout / network error ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å WARN, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º tick
- –ù–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞

### Telegram API
- `"Forbidden: bot was blocked by user"` ‚Üí `SetInactive(username)`
- `"Bad Request: chat not found"` ‚Üí `SetInactive(username)`
- –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ (timeout, 5xx) ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –Ω–µ –ø–æ–º–µ—á–∞—Ç—å notified

### –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø
- `ChatStore` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `sync.RWMutex`
- –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª –∞—Ç–æ–º–∞—Ä–Ω–∞—è: –ø–∏—à–µ–º –≤ `.tmp`, –∑–∞—Ç–µ–º `rename()`

## Edge cases

- Dev mode (`--dev`) ‚Üí UpdateChecker –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- –í–µ—Ä—Å–∏—è = "dev" ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
- `chats.json` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º `RecordInteraction`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω –∏–∑ `allowed_users` ‚Üí –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é)

## –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –°—Ç—Ä–æ–∫ (–æ—Ü–µ–Ω–∫–∞) |
|------|----------------|
| `internal/chatstore/store.go` | ~150 |
| `internal/chatstore/store_test.go` | ~100 |
| `internal/updatechecker/checker.go` | ~120 |
| `internal/updatechecker/checker_test.go` | ~80 |

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `internal/config/config.go` | –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `UpdateCheckInterval` (duration parsing) |
| `internal/bot/bot.go` | –î–æ–±–∞–≤–∏—Ç—å `chatStore` field, –≤—ã–∑–æ–≤ `RecordInteraction()` |
| `internal/bot/options.go` | –î–æ–±–∞–≤–∏—Ç—å `WithChatStore()` option (—Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –µ—Å–ª–∏ –Ω–µ—Ç) |
| `cmd/bot/main.go` | –°–æ–∑–¥–∞–Ω–∏–µ ChatStore, –∑–∞–ø—É—Å–∫ UpdateChecker |
| `internal/updater/github.go` | –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ `Release.Body` (changelog) –¥–æ—Å—Ç—É–ø–µ–Ω |

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∫–æ–º–∞–Ω–¥–∞ `/update` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- Callback `update:confirm` –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–Ω–æ–ø–∫–∏
- –ù–æ–≤–æ–µ –ø–æ–ª–µ –≤ –∫–æ–Ω—Ñ–∏–≥–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
