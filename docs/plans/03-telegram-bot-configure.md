# Telegram Bot: Wizard конфигурации

## Контекст проекта

VPN Director — система управления VPN на роутерах Asus. Telegram бот — альтернативный интерфейс.

Этот модуль реализует интерактивную конфигурацию через inline-кнопки — аналог `configure.sh`.

## Цель этого модуля

Реализовать команду `/configure` — пошаговый wizard с inline-кнопками для настройки Xray.

## Что нужно реализовать

### Wizard flow

```
/configure
    │
    ▼
Шаг 1: Выбор сервера (inline-кнопки)
    │
    ▼
Шаг 2: Исключения (мультивыбор + кнопка "Готово")
    │
    ▼
Шаг 3: Клиенты (добавить/готово цикл)
    │
    ▼
Шаг 4: Подтверждение (применить/отмена)
    │
    ▼
Шаг 5: Применение конфигов + перезапуск Xray
```

### Шаг 1: Выбор сервера

```
┌────────────────────────────────────────┐
│ Выберите Xray сервер:                  │
│                                        │
│ [nl-1 (1.2.3.4)]  [de-2 (5.6.7.8)]    │
│ [us-1 (9.10.11.12)]                    │
└────────────────────────────────────────┘
```

Серверы берутся из `servers.json`. Если пусто — "Сначала импортируйте серверы: /import <url>".

### Шаг 2: Исключения (мультивыбор)

```
┌────────────────────────────────────────┐
│ Исключить из прокси:                   │
│                                        │
│ [✓ ru]  [✓ ua]  [  by]  [  kz]        │
│ [  de]  [  fr]  [  nl]  [  pl]        │
│                                        │
│ [Готово]                               │
└────────────────────────────────────────┘
```

Доступные страны: `ru`, `ua`, `by`, `kz`, `de`, `fr`, `nl`, `pl`, `tr`, `il`
По умолчанию выбрано: `ru`

Нажатие на страну — toggle (выбрать/снять).

### Шаг 3: Клиенты

```
┌────────────────────────────────────────┐
│ Клиенты для Xray: (пока нет)           │
│                                        │
│ [Добавить клиента]  [Готово]           │
└────────────────────────────────────────┘
```

При нажатии "Добавить клиента":
```
┌────────────────────────────────────────┐
│ Введите IP адрес клиента:              │
│ (например: 192.168.1.100)              │
└────────────────────────────────────────┘
```

Пользователь вводит текстом. Валидация: IPv4 формат, LAN диапазон (192.168.x.x, 10.x.x.x, 172.16-31.x.x).

После добавления:
```
┌────────────────────────────────────────┐
│ Клиенты для Xray:                      │
│ • 192.168.1.100                        │
│                                        │
│ [Добавить клиента]  [Готово]           │
└────────────────────────────────────────┘
```

### Шаг 4: Подтверждение

```
┌────────────────────────────────────────┐
│ Конфигурация:                          │
│ • Сервер: nl-1 (1.2.3.4)              │
│ • Исключения: ru, ua                   │
│ • Клиенты: 192.168.1.100              │
│                                        │
│ [Применить]  [Отмена]                  │
└────────────────────────────────────────┘
```

### Шаг 5: Применение

При нажатии "Применить":

```
⏳ Применяю конфигурацию...
```

Действия:
1. Обновить `vpn-director.json`
2. Сгенерировать `xray/config.json` из шаблона
3. Вызвать `xray_tproxy.sh restart`

Результат:
```
✓ vpn-director.json обновлён
✓ xray/config.json обновлён
✓ Xray перезапущен

Готово!
```

### Хранение состояния wizard

```go
type WizardState struct {
    ChatID      int64
    Step        string    // "server", "exclusions", "clients", "confirm"
    Server      *Server
    Exclusions  []string
    Clients     []string
}

// В памяти бота
var wizards = make(map[int64]*WizardState)
```

При перезапуске бота состояние теряется — это ок, wizard занимает 1-2 минуты.

### Обновление vpn-director.json

```go
// Читаем существующий конфиг, обновляем секцию xray
xray := config["xray"].(map[string]interface{})
xray["clients"] = []string{"192.168.1.100"}
xray["exclude_sets"] = []string{"ru", "ua"}
xray["servers"] = []string{"1.2.3.4"}  // IP выбранного сервера
```

### Генерация xray/config.json

Шаблон: `/opt/etc/xray/config.json.template` или `config/xray.json.template`

Подстановки:
- `{{XRAY_SERVER_ADDRESS}}` → server.Address
- `{{XRAY_SERVER_PORT}}` → server.Port
- `{{XRAY_SERVER_UUID}}` → server.UUID

Результат: `/opt/etc/xray/config.json`

### Обработка callback_query

Inline-кнопки генерируют callback_query. Формат callback_data:

```
wizard:server:0          # Выбран сервер с индексом 0
wizard:excl:ru           # Toggle исключения ru
wizard:excl:done         # Готово с исключениями
wizard:client:add        # Добавить клиента
wizard:client:done       # Готово с клиентами
wizard:confirm:apply     # Применить
wizard:confirm:cancel    # Отмена
```

## Структура кода

```
internal/
├── wizard/
│   ├── wizard.go        # WizardState, управление состоянием
│   └── configure.go     # Шаги конфигурации, callbacks
└── vpnconfig/
    ├── director.go      # Работа с vpn-director.json
    └── xray.go          # Генерация xray/config.json
```

## Выходные артефакты

- Работающая команда `/configure`
- Wizard с inline-кнопками
- Генерация конфигов
- Перезапуск Xray

## Зависимости от других модулей

- **01-telegram-bot-core** — базовая структура, авторизация, shell exec
- **02-telegram-bot-import** — чтение servers.json
