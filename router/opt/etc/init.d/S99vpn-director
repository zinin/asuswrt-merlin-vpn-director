#!/bin/sh

PATH=/opt/sbin:/opt/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# Note: We don't source rc.func because VPN Director manages multiple
# subsystems (firewall rules, ipsets, xray) that require custom lifecycle management.
# ENABLED and DESC are kept for consistency with Entware conventions.
ENABLED=yes
DESC="VPN Director"
VPD="/opt/vpn-director/vpn-director.sh"

# Check if vpn-director is installed
if [ ! -x "$VPD" ]; then
    logger -t "S99vpn-director" "vpn-director not found at $VPD"
    exit 0
fi

start() {
    echo "Starting $DESC..."
    if "$VPD" apply; then
        # Remove legacy cron job from previous versions
        cru d update_ipsets 2>/dev/null
        cru a vpn_director_update "0 3 * * * $VPD update"
        /opt/vpn-director/lib/send-email.sh "Startup" "VPN Director started" 2>/dev/null || true
    else
        echo "Failed to start $DESC"
        return 1
    fi
}

stop() {
    echo "Stopping $DESC..."
    "$VPD" stop
    cru d vpn_director_update
    # Also remove legacy cron job if present
    cru d update_ipsets 2>/dev/null
}

case "$1" in
    start)   start ;;
    stop)    stop ;;
    restart) stop; start ;;
    status)  "$VPD" status ;;
    *)       echo "Usage: $0 {start|stop|restart|status}" ;;
esac
