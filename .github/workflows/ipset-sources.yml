name: Test IPSet Sources

on:
  schedule:
    # Run every Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    branches: [master]
    paths:
      - 'router/opt/vpn-director/lib/ipset.sh'
      - 'router/test/integration/ipset_sources.bats'

jobs:
  test-sources:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Bats and helpers
        run: |
          sudo apt-get update
          sudo apt-get install -y bats
          sudo mkdir -p /usr/lib/bats
          sudo git clone https://github.com/bats-core/bats-support.git /usr/lib/bats/bats-support
          sudo git clone https://github.com/bats-core/bats-assert.git /usr/lib/bats/bats-assert

      - name: Test IPSet sources availability
        run: bats router/test/integration/ipset_sources.bats

      - name: Notify on failure
        if: failure()
        run: |
          echo "::warning::One or more IPSet sources may be unavailable or changed format"
